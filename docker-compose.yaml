services:
  openclaw:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - OPENCLAW_BETA=${OPENCLAW_BETA:-false}
    restart: on-failure:10
    ulimits:
      nofile:
        soft: 65535
        hard: 65535
    expose:
      - "18789"
    env_file:
      - .env
    labels:
      - "coolify.managed=true"
    environment:
      DOCKER_HOST: tcp://docker-proxy:2375
      PORT: 18789
      NODE_ENV: production
      HOME: /root
      TERM: xterm-256color

      # OpenClaw config
      OPENCLAW_GATEWAY_BIND: "0.0.0.0"
      OPENCLAW_GATEWAY_PORT: ${OPENCLAW_GATEWAY_PORT:-18789}
      OPENCLAW_STATE_DIR: /root/.openclaw
      OPENCLAW_WORKSPACE: /root/openclaw-workspace

      # API Keys
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      GEMINI_API_KEY: ${GEMINI_API_KEY}

      # Access URLs
      BASE_URL: 'https://${SERVICE_FQDN_OPENCLAW}'
      PUBLIC_URL: 'https://${SERVICE_FQDN_OPENCLAW}'

      # Bootstrap
      OPENCLAW_AUTO_BOOTSTRAP: "1"
      OPENCLAW_PRINT_ACCESS: "1"
      GATEWAY_TRUSTED_PROXIES: '*'

    volumes:
      - openclaw-config:/root/.openclaw
      - openclaw-workspace:/root/openclaw-workspace

    depends_on:
      - docker-proxy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18789/__openclaw__/canvas/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - coolify
      - default
    command: ["bash", "/app/scripts/bootstrap.sh"]

  docker-proxy:
    image: tecnativa/docker-socket-proxy:latest
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      LOG_LEVEL: info
      # Security: Only enable necessary Docker APIs
      POST: 1
      CONTAINERS: 1
      IMAGES: 1
      NETWORKS: 1
      INFO: 1
      VERSION: 1
      EXEC: 1
      EVENTS: 1

volumes:
  openclaw-config:
  openclaw-workspace:

networks:
  coolify:
    external: true
  default:
    driver: bridge
